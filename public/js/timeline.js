let timelineData=[],timelineAttempts=0,timelineSolved=!1,timelineStartHearts=0,dragSrcEl=null;async function startTimeline(){try{const e=await fetch("/api/timeline");timelineData=await e.json()}catch(e){return void showNotification("Failed to load events!")}timelineAttempts=0,timelineSolved=!1,timelineStartHearts=getHearts().current,document.getElementById("timelineStart").style.display="none",document.getElementById("timelineArea").style.display="block",updateStreak(),renderTimeline()}function renderTimeline(){const e=document.getElementById("timelineList");e.innerHTML="";[...timelineData].sort(()=>Math.random()-.5).forEach(t=>{const n=document.createElement("div");n.className="timeline-item",n.draggable=!0,n.dataset.year=t.year,n.innerHTML=`\n      <div class="timeline-grip">‚†ø</div>\n      <div class="timeline-emoji">${t.emoji}</div>\n      <div class="timeline-text">\n        <div class="timeline-event">${t.event}</div>\n      </div>\n      <div class="timeline-year-badge">????</div>\n    `,n.addEventListener("dragstart",handleDragStart),n.addEventListener("dragover",handleDragOver),n.addEventListener("dragenter",handleDragEnter),n.addEventListener("dragleave",handleDragLeave),n.addEventListener("drop",handleDrop),n.addEventListener("dragend",handleDragEnd),n.addEventListener("touchstart",handleTouchStart,{passive:!1}),n.addEventListener("touchmove",handleTouchMove,{passive:!1}),n.addEventListener("touchend",handleTouchEnd),e.appendChild(n)});const t=document.getElementById("timelineHearts");if(t){const e=getHearts();t.textContent="‚ù§Ô∏è".repeat(e.current)+"üñ§".repeat(5-e.current)}"undefined"!=typeof Mascot&&Mascot.onThink()}function handleDragStart(e){timelineSolved||(dragSrcEl=this,this.classList.add("dragging"),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",""))}function handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function handleDragEnter(e){e.preventDefault(),this!==dragSrcEl&&this.classList.add("drag-over")}function handleDragLeave(){this.classList.remove("drag-over")}function handleDrop(e){if(e.preventDefault(),e.stopPropagation(),dragSrcEl===this||!dragSrcEl)return;this.classList.remove("drag-over");const t=document.getElementById("timelineList"),n=Array.from(t.children);n.indexOf(dragSrcEl)<n.indexOf(this)?t.insertBefore(dragSrcEl,this.nextSibling):t.insertBefore(dragSrcEl,this),playSound("flip")}function handleDragEnd(){this.classList.remove("dragging"),document.querySelectorAll(".timeline-item").forEach(e=>{e.classList.remove("drag-over")})}let touchStartY=0,touchEl=null,touchClone=null;function handleTouchStart(e){timelineSolved||(touchEl=this,touchStartY=e.touches[0].clientY,this.classList.add("dragging"),touchClone=this.cloneNode(!0),touchClone.style.cssText="position:fixed;z-index:9999;pointer-events:none;opacity:0.8;width:"+this.offsetWidth+"px;transform:scale(1.02);",touchClone.style.top=e.touches[0].clientY-30+"px",touchClone.style.left=this.getBoundingClientRect().left+"px",document.body.appendChild(touchClone),e.preventDefault())}function handleTouchMove(e){if(!touchEl||!touchClone)return;e.preventDefault();const t=e.touches[0].clientY;touchClone.style.top=t-30+"px",touchClone.style.display="none";const n=document.elementFromPoint(e.touches[0].clientX,t);touchClone.style.display="",document.querySelectorAll(".timeline-item").forEach(e=>e.classList.remove("drag-over"));const i=n?n.closest(".timeline-item"):null;i&&i!==touchEl&&i.classList.add("drag-over")}function handleTouchEnd(e){if(!touchEl)return;touchClone&&(touchClone.remove(),touchClone=null);const t=e.changedTouches[0].clientY,n=document.elementFromPoint(e.changedTouches[0].clientX,t),i=n?n.closest(".timeline-item"):null;if(i&&i!==touchEl){const e=document.getElementById("timelineList"),t=Array.from(e.children);t.indexOf(touchEl)<t.indexOf(i)?e.insertBefore(touchEl,i.nextSibling):e.insertBefore(touchEl,i),playSound("flip")}touchEl.classList.remove("dragging"),document.querySelectorAll(".timeline-item").forEach(e=>e.classList.remove("drag-over")),touchEl=null}function checkTimeline(){if(timelineSolved)return;if(!hasHearts())return;timelineAttempts++,document.getElementById("timelineAttempts").textContent=`ATTEMPTS: ${timelineAttempts}`;const e=document.querySelectorAll(".timeline-item"),t=[...Array.from(e).map(e=>parseInt(e.dataset.year))].sort((e,t)=>e-t);let n=0;e.forEach((e,i)=>{const l=parseInt(e.dataset.year);e.classList.remove("timeline-correct","timeline-wrong"),l===t[i]?(e.classList.add("timeline-correct"),e.querySelector(".timeline-year-badge").textContent=l,n++):e.classList.add("timeline-wrong")});const i=n/e.length*100;if(document.getElementById("timelineProgressFill").style.width=i+"%",document.getElementById("timelineProgressText").textContent=`${n}/${e.length} correct`,n===e.length)timelineSolved=!0,playSound("correct"),"undefined"!=typeof Mascot&&Mascot.onCorrect(),e.forEach(e=>{e.querySelector(".timeline-year-badge").textContent=e.dataset.year}),showTimelineFact(),setTimeout(()=>finishTimeline(),2e3);else{playSound("wrong"),loseHeart(),"undefined"!=typeof Mascot&&Mascot.onWrong();const e=document.getElementById("timelineHearts");if(e){const t=getHearts();e.textContent="‚ù§Ô∏è".repeat(t.current)+"üñ§".repeat(5-t.current)}showTimelineFact()}}function showTimelineFact(){const e=document.querySelectorAll(".timeline-correct");if(0===e.length)return;const t=e[Math.floor(Math.random()*e.length)],n=parseInt(t.dataset.year),i=timelineData.find(e=>e.year===n);if(i){const e=document.getElementById("timelineFact");e.textContent="üí° "+i.fact,e.style.display="block"}}function finishTimeline(){const e=Math.max(1,4-timelineAttempts);addXP(50),1===timelineAttempts&&addXP(25),markNodeComplete("timeline"),getHearts().current===timelineStartHearts&&awardAchievement("no_hearts_lost"),1===timelineAttempts&&awardAchievement("perfect_score"),showResults("Timeline Sort Complete!",e,3,"timeline")}