let listenData=[],listenCurrent=0,listenScore=0,listenAnswered=!1,listenStartHearts=0;async function startListening(){try{const e=await fetch("/api/listening");listenData=await e.json()}catch(e){return void showNotification("Failed to load questions!")}listenCurrent=0,listenScore=0,listenAnswered=!1,listenStartHearts=getHearts().current,document.getElementById("listenStart").style.display="none",document.getElementById("listenArea").style.display="block",updateStreak(),showListenQuestion()}function showListenQuestion(){if(listenCurrent>=listenData.length)return void finishListening();listenAnswered=!1;const e=listenData[listenCurrent],t=listenData.length;document.getElementById("listenProgressFill").style.width=listenCurrent/t*100+"%",document.getElementById("listenProgressText").textContent=`${listenCurrent+1}/${t}`,document.getElementById("listenScore").textContent=`SCORE: ${listenScore}`;const n=document.getElementById("listenHearts");if(n){const e=getHearts();n.textContent="â¤ï¸".repeat(e.current)+"ðŸ–¤".repeat(5-e.current)}document.getElementById("listenReveal").style.display="none";const s=document.getElementById("listenOptions");s.innerHTML="";[...e.options].sort(()=>Math.random()-.5).forEach(e=>{const t=document.createElement("button");t.className="quiz-option",t.textContent=e,t.onclick=()=>answerListen(e,t),s.appendChild(t)}),document.getElementById("listenNextBtn").style.display="none";const i=document.getElementById("listenCard");i.style.animation="none",i.offsetHeight,i.style.animation="fadeUp 0.4s ease","undefined"!=typeof Mascot&&Mascot.onThink(),setTimeout(()=>playCurrentWord(),500)}function playCurrentWord(){if(listenCurrent>=listenData.length)return;const e=listenData[listenCurrent];if(!("speechSynthesis"in window))return void showNotification("Speech not supported in this browser!");speechSynthesis.cancel();const t=new SpeechSynthesisUtterance(e.arabic);t.rate=.7,t.pitch=1,t.volume=1;const n=speechSynthesis.getVoices().find(e=>e.lang.startsWith("ar"));n&&(t.voice=n);const s=document.getElementById("listenPlayBtn");s&&(s.classList.add("pulsing"),t.onend=()=>s.classList.remove("pulsing")),speechSynthesis.speak(t)}function answerListen(e,t){if(listenAnswered)return;listenAnswered=!0;const n=listenData[listenCurrent],s=document.querySelectorAll("#listenOptions .quiz-option"),i=e===n.answer;s.forEach(e=>e.classList.add("disabled")),i?(t.classList.add("correct"),listenScore++,playSound("correct"),addXP(10),"undefined"!=typeof Mascot&&Mascot.onCorrect()):(t.classList.add("wrong"),s.forEach(e=>{e.textContent===n.answer&&e.classList.add("correct")}),playSound("wrong"),loseHeart(),"undefined"!=typeof Mascot&&Mascot.onWrong()),document.getElementById("listenScore").textContent=`SCORE: ${listenScore}`;const o=document.getElementById("listenReveal");document.getElementById("listenArabic").textContent=n.arabic,document.getElementById("listenTranslit").textContent=n.transliteration||"",o.style.display="flex";const l=document.getElementById("listenNextBtn");l.textContent=listenCurrent<listenData.length-1?"NEXT â†’":"SEE RESULTS ðŸ†",l.style.display="inline-flex";const r=document.getElementById("listenHearts");if(r){const e=getHearts();r.textContent="â¤ï¸".repeat(e.current)+"ðŸ–¤".repeat(5-e.current)}}function nextListenQuestion(){hasHearts()&&(listenCurrent++,showListenQuestion())}function finishListening(){const e=listenData.length;addXP(50),listenScore===e&&addXP(25),markNodeComplete("listening"),getHearts().current===listenStartHearts&&awardAchievement("no_hearts_lost"),listenScore===e&&awardAchievement("perfect_score"),showResults("Listening Challenge Complete!",listenScore,e,"listening")}